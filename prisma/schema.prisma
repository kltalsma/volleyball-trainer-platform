// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User and Authentication
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  password      String
  image         String?
  role          UserRole  @default(TRAINER)
  theme         String?   @default("default")
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // Relations
  teams         TeamMember[]
  createdExercises Exercise[]
  createdWorkouts  Workout[]
  favoriteExercises FavoriteExercise[]
  
  @@map("users")
}

enum UserRole {
  TRAINER
  ADMIN
  PLAYER
}

// Sports
model Sport {
  id        String     @id @default(cuid())
  name      String     @unique
  slug      String     @unique
  icon      String?
  active    Boolean    @default(true)
  createdAt DateTime   @default(now())
  
  // Relations
  exercises Exercise[]
  teams     Team[]
  
  @@map("sports")
}

// Teams
model Team {
  id          String       @id @default(cuid())
  name        String
  sportId     String
  description String?
  
  // Volleybal.nl integration (optional)
  volleybalNlApiId    String?  // e.g., "/competitie/teams/ckl6f7m/meiden-b/1"
  volleybalNlClubId   String?  // e.g., "ckl6f7m"
  volleybalNlCategory String?  // e.g., "meiden-b"
  volleybalNlTeamNumber Int?   // e.g., 1
  
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  
  // Relations
  sport       Sport        @relation(fields: [sportId], references: [id])
  members     TeamMember[]
  workouts    Workout[]
  trainingSessions TrainingSession[]
  
  @@map("teams")
}

model TeamMember {
  id        String   @id @default(cuid())
  teamId    String
  userId    String
  role      MemberRole @default(PLAYER)
  number    Int?
  position  String?
  joinedAt  DateTime @default(now())
  
  // Relations
  team      Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  attendance TrainingAttendance[]
  
  @@unique([teamId, userId])
  @@map("team_members")
}

enum MemberRole {
  COACH
  ASSISTANT_COACH
  PLAYER
  PARENT
  VOLUNTEER
}

// Exercises
model Exercise {
  id          String    @id @default(cuid())
  title       String
  description String?
  duration    Int?      // in minutes
  difficulty  Difficulty @default(MEDIUM)
  sportId     String
  categoryId  String?
  creatorId   String
  isPublic    Boolean   @default(false)
  diagram     String?   // JSON string for drawing data
  videoUrl    String?
  tags        String[]
  views       Int       @default(0)
  
  // Enhanced filtering fields
  techniques  String[]  @default([])  // e.g., ["attack", "defense", "serve", "pass", "block", "set"]
  playerMin   Int?      // Minimum number of players
  playerMax   Int?      // Maximum number of players
  skillLevel  SkillLevel? // Skill level required for this exercise
  materials   Json?     // e.g., [{ name: "Balls", quantity: 8 }, { name: "Cones", quantity: 4 }]
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  // Relations
  sport       Sport     @relation(fields: [sportId], references: [id])
  category    ExerciseCategory? @relation(fields: [categoryId], references: [id])
  creator     User      @relation(fields: [creatorId], references: [id])
  workoutExercises WorkoutExercise[]
  favorites   FavoriteExercise[]
  
  @@index([sportId])
  @@index([creatorId])
  @@index([isPublic])
  @@map("exercises")
}

enum Difficulty {
  EASY
  MEDIUM
  HARD
}

enum SkillLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
}

model ExerciseCategory {
  id        String     @id @default(cuid())
  name      String
  slug      String     @unique
  createdAt DateTime   @default(now())
  
  // Relations
  exercises Exercise[]
  
  @@map("exercise_categories")
}

model FavoriteExercise {
  id         String   @id @default(cuid())
  userId     String
  exerciseId String
  createdAt  DateTime @default(now())
  
  // Relations
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  exercise   Exercise @relation(fields: [exerciseId], references: [id], onDelete: Cascade)
  
  @@unique([userId, exerciseId])
  @@map("favorite_exercises")
}

// Workouts/Trainings
model Workout {
  id          String    @id @default(cuid())
  title       String
  description String?
  startTime   DateTime? // When the training starts
  endTime     DateTime? // When the training ends
  totalDuration Int?    // in minutes (calculated or manual)
  sportId     String?
  creatorId   String
  isPublic    Boolean   @default(false)
  teamId      String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  // Relations
  creator     User      @relation(fields: [creatorId], references: [id])
  team        Team?     @relation(fields: [teamId], references: [id])
  exercises   WorkoutExercise[]
  trainingSessions TrainingSession[]
  
  @@index([creatorId])
  @@index([teamId])
  @@index([isPublic])
  @@map("workouts")
}

model WorkoutExercise {
  id         String   @id @default(cuid())
  workoutId  String
  exerciseId String
  order      Int
  duration   Int?     // in minutes
  notes      String?
  
  // Relations
  workout    Workout  @relation(fields: [workoutId], references: [id], onDelete: Cascade)
  exercise   Exercise @relation(fields: [exerciseId], references: [id])
  
  @@unique([workoutId, order])
  @@map("workout_exercises")
}

// Training Sessions (scheduled workouts)
model TrainingSession {
  id          String    @id @default(cuid())
  teamId      String
  workoutId   String?
  title       String
  description String?
  scheduledAt DateTime
  duration    Int?      // in minutes
  location    String?
  status      SessionStatus @default(SCHEDULED)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  // Relations
  team        Team      @relation(fields: [teamId], references: [id], onDelete: Cascade)
  workout     Workout?  @relation(fields: [workoutId], references: [id])
  attendance  TrainingAttendance[]
  
  @@index([teamId])
  @@index([scheduledAt])
  @@map("training_sessions")
}

enum SessionStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

model TrainingAttendance {
  id        String   @id @default(cuid())
  sessionId String
  memberId  String
  status    AttendanceStatus @default(PENDING)
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  session   TrainingSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  member    TeamMember      @relation(fields: [memberId], references: [id], onDelete: Cascade)
  
  @@unique([sessionId, memberId])
  @@map("training_attendance")
}

enum AttendanceStatus {
  PENDING
  PRESENT
  ABSENT
  LATE
  EXCUSED
}
