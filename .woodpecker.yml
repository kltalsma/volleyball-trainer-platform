# Woodpecker CI Pipeline for Volleyball Trainer Platform
# https://woodpecker-ci.org/docs/usage/intro
#
# Deployment Strategy:
# - Test Environment (k3s): Deploys on PRs and main branch pushes for testing/staging
# - Production (Railway): Auto-deploys from main branch via GitHub integration
# 
# CI/CD Flow:
# 1. Create PR ‚Üí Woodpecker tests & deploys to k3s (preview)
# 2. Merge to main ‚Üí Woodpecker deploys to k3s (staging mirror) + Railway deploys (production)
# 3. k3s and Railway stay in sync after merge

when:
  - event: [pull_request, manual]
  - event: push
    branch: main

steps:
  # Install dependencies and run tests
  test:
    image: node:20-alpine
    commands:
      - echo "Installing dependencies..."
      - npm ci
      
      # Generate Prisma client for tests
      - echo "Generating Prisma client..."
      - export DATABASE_URL="postgresql://placeholder:placeholder@placeholder:5432/placeholder"
      - npx prisma generate
      
      # Run type checking
      - echo "Running type check..."
      - npm run build || echo "Build check completed"

  # Build Docker image for k3s deployment (test environment)
  build-docker:
    image: docker:24-dind
    privileged: true
    when:
      event: [pull_request, manual, push]
      branch: [main, feature/*, develop]
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    commands:
      - echo "Building Docker image for k3s test environment..."
      - export BUILD_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
      - docker build --build-arg COMMIT_HASH=${CI_COMMIT_SHA} --build-arg BUILD_TIME=${BUILD_TIME} --build-arg ENVIRONMENT=staging -t volleyball-trainer-platform:${CI_COMMIT_SHA:0:8} .
      - docker tag volleyball-trainer-platform:${CI_COMMIT_SHA:0:8} volleyball-trainer-platform:latest
      - echo "Docker image built successfully with version info - Commit ${CI_COMMIT_SHA} - Build Time ${BUILD_TIME} - Environment staging"
      - docker images | grep volleyball-trainer-platform

  # Deploy to k3s test environment on Sirius
  deploy-k3s:
    image: bitnami/kubectl:latest
    when:
      event: [pull_request, manual, push]
      branch: main
    volumes:
      - /home/kltalsma/.kube/config-woodpecker:/root/.kube/config:ro
    commands:
      - echo "Deploying to k3s test environment on Sirius..."
      
      - echo "Testing kubectl connection..."
      - kubectl cluster-info || echo "Connection check failed"
      
      - echo "Restarting deployment to pick up new image..."
      - kubectl rollout restart deployment/volleyball-app -n volleyball-trainer
      - echo "Waiting for rollout to complete..."
      - kubectl rollout status deployment/volleyball-app -n volleyball-trainer --timeout=5m
      
      - echo ""
      - echo "‚úÖ Deployment to k3s complete!"
      - echo "üîó k3s URL http://192.168.68.78:30100"
      - echo ""
      - echo "‚ÑπÔ∏è Railway production deploys in parallel from main branch"
      - echo "üîó Production URL https://volleyball-trainer-platform-production.up.railway.app/"

  # Lint and code quality checks
  lint:
    image: node:20-alpine
    commands:
      - echo "Installing dependencies for linting..."
      - npm ci
      - echo "Running ESLint..."
      - npx eslint . --ext .ts,.tsx --max-warnings 100 || echo "Linting completed with warnings"
      
      # Check for debugging code
      - echo "Checking for console statements..."
      - grep -r "console\.log" src/ && echo "‚ö†Ô∏è Found console.log statements" || echo "‚úÖ No console.log found"
